<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OPD Slot Templates ‚Äî AMH Admin</title>
  <link rel="icon" type="image/x-icon" href="../../assets/images/favicon.ico">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../../assets/css/main.css">
  <link rel="stylesheet" href="../../assets/css/components.css">
</head>
<body>

<nav class="navbar" role="navigation" aria-label="Admin navigation">
  <a href="../../admin/dashboard.html" class="navbar__brand">
    <div class="navbar__logo" style="display:flex;align-items:center;justify-content:center;font-size:20px;">üè•</div>
    <div class="navbar__brand-text">
      <span class="navbar__brand-name">AMH Admin</span>
      <span class="navbar__brand-sub">OPD Slot Manager</span>
    </div>
  </a>
  <nav class="navbar__nav">
    <a href="../../admin/dashboard.html" class="navbar__link">üè† Dashboard</a>
    <a href="../../admin/opd/bookings.html" class="navbar__link">üìã OPD Queue</a>
    <a href="../../admin/opd/slots.html" class="navbar__link navbar__link--active" aria-current="page">‚è∞ OPD Slots</a>
    <a href="../../admin/patients/verify.html" class="navbar__link">üîç Verify Patient</a>
  </nav>
  <div class="navbar__actions">
    <div class="navbar__user">
      <div class="navbar__user-avatar" id="admin-nav-avatar">?</div>
      <span class="navbar__user-name" id="admin-nav-name">Loading...</span>
    </div>
    <button class="navbar__logout" data-action="admin-logout" type="button">üö™ Logout</button>
  </div>
  <button class="navbar__menu-toggle" id="navbar-menu-toggle" aria-label="Open menu" type="button">
    <span></span><span></span><span></span>
  </button>
</nav>

<div class="navbar__mobile-nav" id="navbar-mobile-nav">
  <a href="../../admin/dashboard.html" class="navbar__link">üè† Dashboard</a>
  <a href="../../admin/opd/bookings.html" class="navbar__link">üìã OPD Queue</a>
  <a href="../../admin/opd/slots.html" class="navbar__link navbar__link--active">‚è∞ OPD Slots</a>
  <button class="navbar__logout" data-action="admin-logout" style="margin-top:var(--space-4);width:100%;justify-content:center;" type="button">üö™ Logout</button>
</div>

<main class="page-main" style="max-width: 900px; margin: var(--navbar-height) auto 0;">
  <div class="page-header flex-between" style="flex-wrap:wrap;gap:var(--space-4);">
    <div>
      <h1 class="page-header__title">‚è∞ OPD Slot Templates</h1>
      <p class="page-header__subtitle">Configure appointment time boxes for each day of the week</p>
    </div>
    <button class="btn btn--primary" id="add-slot-btn" type="button" aria-label="Add new time slot">
      + Add Time Slot
    </button>
  </div>

  <!-- 7-Day Tab Navigation -->
  <div class="tabs">
    <div class="tabs__nav tabs__nav--7day" role="tablist" aria-label="Day of week" id="day-tabs">
      <button class="tabs__tab" data-dow="0" role="tab" type="button">Sun</button>
      <button class="tabs__tab" data-dow="1" role="tab" type="button">Mon</button>
      <button class="tabs__tab" data-dow="2" role="tab" type="button">Tue</button>
      <button class="tabs__tab" data-dow="3" role="tab" type="button">Wed</button>
      <button class="tabs__tab" data-dow="4" role="tab" type="button">Thu</button>
      <button class="tabs__tab" data-dow="5" role="tab" type="button">Fri</button>
      <button class="tabs__tab" data-dow="6" role="tab" type="button">Sat</button>
    </div>

    <div class="tabs__content">
      <div id="slots-list" style="display:flex;flex-direction:column;gap:var(--space-3);" aria-live="polite">
        <div class="skeleton skeleton--card"></div>
      </div>
    </div>
  </div>
</main>

<!-- Add/Edit Slot Modal -->
<div class="modal-backdrop" id="slot-modal" style="display:none;" role="dialog" aria-modal="true" aria-labelledby="slot-modal-title">
  <div class="modal">
    <div class="modal__header">
      <div>
        <div class="modal__title" id="slot-modal-title">Add Time Slot</div>
        <div class="modal__subtitle" id="slot-modal-subtitle">New appointment time box</div>
      </div>
      <button class="modal__close" id="slot-modal-close" aria-label="Close modal" type="button">‚úï</button>
    </div>
    <div class="modal__body">
      <form id="slot-form" novalidate>
        <input type="hidden" id="slot-edit-id">
        <input type="hidden" id="slot-edit-dow">

        <div class="form-row">
          <div class="form-group">
            <label class="form-label form-label--required" for="slot-start-time">Start Time</label>
            <input type="time" id="slot-start-time" name="start_time" class="form-input" aria-required="true">
          </div>
          <div class="form-group">
            <label class="form-label form-label--required" for="slot-end-time">End Time</label>
            <input type="time" id="slot-end-time" name="end_time" class="form-input" aria-required="true">
          </div>
        </div>

        <div class="form-group">
          <label class="form-label form-label--required" for="slot-max-slots">Maximum Slots</label>
          <input
            type="number"
            id="slot-max-slots"
            name="max_slots"
            class="form-input"
            placeholder="e.g. 15"
            min="1"
            max="500"
            aria-required="true"
          >
          <p class="form-hint">Number of patients that can book this time slot (1‚Äì500)</p>
        </div>
      </form>
    </div>
    <div class="modal__footer">
      <button class="btn btn--ghost" id="slot-modal-cancel" type="button">Cancel</button>
      <button class="btn btn--primary" id="slot-modal-save" type="button">Save Time Slot</button>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-backdrop" id="delete-modal" style="display:none;" role="dialog" aria-modal="true" aria-labelledby="delete-modal-title">
  <div class="modal modal--sm modal--confirm" data-confirm-only="true">
    <div class="modal__header">
      <div><div class="modal__title" id="delete-modal-title" style="color:var(--color-danger-dark);">Delete Time Slot</div></div>
    </div>
    <div class="modal__body">
      <p style="color:var(--color-text-secondary);" id="delete-modal-msg">
        Are you sure? This will deactivate this time slot. Existing bookings will not be affected.
      </p>
    </div>
    <div class="modal__footer">
      <button class="btn btn--ghost" id="delete-modal-cancel" type="button">Keep Slot</button>
      <button class="btn btn--danger" id="delete-modal-confirm" type="button">Delete Slot</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js" crossorigin="anonymous"></script>
<script src="../../config.js"></script>
<script src="../../assets/js/utils.js"></script>
<script src="../../assets/js/supabase.js"></script>
<script src="../../assets/js/audit.js"></script>
<script src="../../assets/js/admin-auth.js"></script>

<script>
'use strict';

let adminSession = null;
let currentDow = new Date().getDay(); // default to today
let allTemplates = [];
let pendingDeleteId = null;

const DAY_NAMES = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

async function initOPDSlots() {
  adminSession = await requireAdminAuth(['opd']);
  if (!adminSession) return;

  populateAdminNavbar(adminSession);

  initAdminNavbarMobile();

  // Set active day tab to current day
  activateTab(currentDow);

  // Tab click handlers
  document.querySelectorAll('[data-dow]').forEach(tab => {
    tab.addEventListener('click', () => {
      currentDow = parseInt(tab.dataset.dow, 10);
      activateTab(currentDow);
      loadSlots();
    });
  });

  // Add slot button
  document.getElementById('add-slot-btn')?.addEventListener('click', () => openAddModal());

  // Modal controls
  document.getElementById('slot-modal-close')?.addEventListener('click', () => closeModal('slot-modal'));
  document.getElementById('slot-modal-cancel')?.addEventListener('click', () => closeModal('slot-modal'));
  document.getElementById('slot-modal-save')?.addEventListener('click', saveSlot);

  document.getElementById('delete-modal-cancel')?.addEventListener('click', () => closeModal('delete-modal'));
  document.getElementById('delete-modal-confirm')?.addEventListener('click', confirmDelete);

  await loadAllTemplates();
  renderSlots();
}

function activateTab(dow) {
  document.querySelectorAll('[data-dow]').forEach(tab => {
    const isActive = parseInt(tab.dataset.dow, 10) === dow;
    tab.classList.toggle('tabs__tab--active', isActive);
    tab.setAttribute('aria-selected', isActive);
  });
}

async function loadAllTemplates() {
  const { data, error } = await getAllOPDTemplates();
  if (error) {
    Toast.error('Error', 'Failed to load templates: ' + error);
    return;
  }
  allTemplates = data || [];
}

async function loadSlots() {
  await loadAllTemplates();
  renderSlots();
}

function renderSlots() {
  const container = document.getElementById('slots-list');
  if (!container) return;

  const dayTemplates = allTemplates.filter(t => t.day_of_week === currentDow);

  if (dayTemplates.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-state__icon">‚è∞</div>
        <div class="empty-state__title">No Slots for ${DAY_NAMES[currentDow]}</div>
        <div class="empty-state__text">No time slots are configured for this day. Click "+ Add Time Slot" to create one.</div>
      </div>
    `;
    return;
  }

  container.innerHTML = dayTemplates.map(template => `
    <div class="slot-template-row" style="display:grid;grid-template-columns:1fr 1fr auto auto auto;gap:var(--space-4);align-items:center;">
      <div>
        <div class="slot-template-row__time">${formatTimeRange(template.start_time, template.end_time)}</div>
        <div style="font-size:var(--font-size-xs);color:var(--color-text-muted);">${DAY_NAMES[template.day_of_week]}</div>
      </div>
      <div class="slot-template-row__max">
        <div style="font-weight:600;">${template.max_slots} slots</div>
        <div style="font-size:var(--font-size-xs);color:var(--color-text-muted);">maximum</div>
      </div>
      <span class="badge ${template.is_active ? 'badge--active' : 'badge--inactive'}">
        ${template.is_active ? 'Active' : 'Inactive'}
      </span>
      <button
        class="btn btn--ghost btn--sm"
        onclick="openEditModal('${template.id}')"
        aria-label="Edit time slot ${formatTimeRange(template.start_time, template.end_time)}"
        type="button"
      >Edit</button>
      <button
        class="btn btn--danger btn--sm"
        onclick="openDeleteModal('${template.id}', '${formatTimeRange(template.start_time, template.end_time)}')"
        aria-label="Delete time slot ${formatTimeRange(template.start_time, template.end_time)}"
        type="button"
      >Delete</button>
    </div>
  `).join('');
}

function openAddModal() {
  document.getElementById('slot-modal-title').textContent = `Add Time Slot ‚Äî ${DAY_NAMES[currentDow]}`;
  document.getElementById('slot-modal-subtitle').textContent = `New appointment time box for ${DAY_NAMES[currentDow]}`;
  document.getElementById('slot-edit-id').value = '';
  document.getElementById('slot-edit-dow').value = currentDow;
  document.getElementById('slot-start-time').value = '';
  document.getElementById('slot-end-time').value = '';
  document.getElementById('slot-max-slots').value = '';
  clearAllFormErrors(document.getElementById('slot-form'));
  openModal('slot-modal');
}

function openEditModal(templateId) {
  const template = allTemplates.find(t => t.id === templateId);
  if (!template) return;

  document.getElementById('slot-modal-title').textContent = 'Edit Time Slot';
  document.getElementById('slot-modal-subtitle').textContent = `${DAY_NAMES[template.day_of_week]}`;
  document.getElementById('slot-edit-id').value = templateId;
  document.getElementById('slot-edit-dow').value = template.day_of_week;
  document.getElementById('slot-start-time').value = template.start_time.slice(0, 5);
  document.getElementById('slot-end-time').value = template.end_time.slice(0, 5);
  document.getElementById('slot-max-slots').value = template.max_slots;
  clearAllFormErrors(document.getElementById('slot-form'));
  openModal('slot-modal');
}

function openDeleteModal(templateId, timeLabel) {
  pendingDeleteId = templateId;
  document.getElementById('delete-modal-msg').textContent =
    `Delete the ${timeLabel} slot? This will deactivate it. Existing bookings on past dates will remain.`;
  openModal('delete-modal');
}

async function saveSlot() {
  const form = document.getElementById('slot-form');
  const saveBtn = document.getElementById('slot-modal-save');
  const editId = document.getElementById('slot-edit-id').value;
  const dow = parseInt(document.getElementById('slot-edit-dow').value, 10);
  const startTime = document.getElementById('slot-start-time').value;
  const endTime = document.getElementById('slot-end-time').value;
  const maxSlots = document.getElementById('slot-max-slots').value;

  clearAllFormErrors(form);
  let hasErrors = false;

  if (!startTime) {
    showFieldError(document.getElementById('slot-start-time'), 'Start time is required');
    hasErrors = true;
  }
  if (!endTime) {
    showFieldError(document.getElementById('slot-end-time'), 'End time is required');
    hasErrors = true;
  }
  if (startTime && endTime && !validateTimeRange(startTime, endTime)) {
    showFieldError(document.getElementById('slot-end-time'), 'End time must be after start time');
    hasErrors = true;
  }
  if (!validateMaxSlots(maxSlots)) {
    showFieldError(document.getElementById('slot-max-slots'), 'Enter a number between 1 and 500');
    hasErrors = true;
  }
  if (hasErrors) return;

  disableSubmitButton(saveBtn, 'Saving...');

  try {
    let result;
    if (editId) {
      result = await updateOPDTemplate(editId, {
        start_time: startTime,
        end_time: endTime,
        max_slots: parseInt(maxSlots, 10),
        is_active: true,
      });
      if (!result.error) {
        await auditSlotAction(adminSession.id, AUDIT_ACTIONS.UPDATE_OPD_SLOT, editId, {
          start_time: startTime, end_time: endTime, max_slots: parseInt(maxSlots, 10),
        });
      }
    } else {
      result = await createOPDTemplate({
        day_of_week: dow,
        start_time: startTime,
        end_time: endTime,
        max_slots: parseInt(maxSlots, 10),
      }, adminSession.id);
      if (!result.error && result.data) {
        await auditSlotAction(adminSession.id, AUDIT_ACTIONS.CREATE_OPD_SLOT, result.data.id, {
          day_of_week: dow, start_time: startTime, end_time: endTime, max_slots: parseInt(maxSlots, 10),
        });
      }
    }

    if (result.error) {
      Toast.error('Save Failed', result.error);
    } else {
      Toast.success('Saved', 'Time slot saved successfully.');
      closeModal('slot-modal');
      await loadSlots();
    }
  } catch (err) {
    Toast.error('Error', err.message);
  } finally {
    enableSubmitButton(saveBtn);
  }
}

async function confirmDelete() {
  if (!pendingDeleteId) return;

  const deleteBtn = document.getElementById('delete-modal-confirm');
  disableSubmitButton(deleteBtn, 'Deleting...');

  try {
    const result = await deactivateOPDTemplate(pendingDeleteId);
    if (result.error) {
      Toast.error('Delete Failed', result.error);
    } else {
      await auditSlotAction(adminSession.id, AUDIT_ACTIONS.DELETE_OPD_SLOT, pendingDeleteId, {});
      Toast.success('Deleted', 'Time slot deactivated successfully.');
      closeModal('delete-modal');
      await loadSlots();
    }
  } catch (err) {
    Toast.error('Error', err.message);
  } finally {
    enableSubmitButton(deleteBtn);
    pendingDeleteId = null;
  }
}

document.addEventListener('DOMContentLoaded', initOPDSlots);
</script>
</body>
</html>
