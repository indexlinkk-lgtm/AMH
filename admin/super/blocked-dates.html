<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Blocked Dates â€” AMH Super Admin</title>
  <link rel="icon" type="image/x-icon" href="../../assets/images/favicon.ico">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../../assets/css/main.css">
  <link rel="stylesheet" href="../../assets/css/components.css">
</head>
<body>

<nav class="navbar" role="navigation" aria-label="Admin navigation">
  <a href="../../admin/dashboard.html" class="navbar__brand">
    <div class="navbar__logo" style="display:flex;align-items:center;justify-content:center;font-size:20px;">ğŸ¥</div>
    <div class="navbar__brand-text">
      <span class="navbar__brand-name">AMH Super Admin</span>
      <span class="navbar__brand-sub">Blocked Dates</span>
    </div>
  </a>
  <nav class="navbar__nav">
    <a href="../../admin/dashboard.html" class="navbar__link">ğŸ  Dashboard</a>
    <a href="../../admin/super/admins.html" class="navbar__link">ğŸ‘¥ Admins</a>
    <a href="../../admin/super/blocked-dates.html" class="navbar__link navbar__link--active" aria-current="page">ğŸ“† Blocked Dates</a>
    <a href="../../admin/super/audit.html" class="navbar__link">ğŸ“‹ Audit Log</a>
    <a href="../../admin/super/reports.html" class="navbar__link">ğŸ“Š Reports</a>
  </nav>
  <div class="navbar__actions">
    <div class="navbar__user">
      <div class="navbar__user-avatar" id="admin-nav-avatar">?</div>
      <span class="navbar__user-name" id="admin-nav-name">Loading...</span>
    </div>
    <button class="navbar__logout" data-action="admin-logout" type="button">ğŸšª Logout</button>
  </div>
  <button class="navbar__menu-toggle" id="navbar-menu-toggle" aria-label="Open menu" type="button">
    <span></span><span></span><span></span>
  </button>
</nav>

<div class="navbar__mobile-nav" id="navbar-mobile-nav">
  <a href="../../admin/dashboard.html" class="navbar__link">ğŸ  Dashboard</a>
  <a href="../../admin/super/admins.html" class="navbar__link">ğŸ‘¥ Admins</a>
  <a href="../../admin/super/blocked-dates.html" class="navbar__link navbar__link--active">ğŸ“† Blocked Dates</a>
  <a href="../../admin/super/audit.html" class="navbar__link">ğŸ“‹ Audit Log</a>
  <a href="../../admin/super/reports.html" class="navbar__link">ğŸ“Š Reports</a>
  <button class="navbar__logout" data-action="admin-logout" style="margin-top:var(--space-4);width:100%;justify-content:center;" type="button">ğŸšª Logout</button>
</div>

<main class="page-main" style="max-width:900px;margin:var(--navbar-height) auto 0;">
  <div class="page-header flex-between" style="flex-wrap:wrap;gap:var(--space-4);">
    <div>
      <h1 class="page-header__title">ğŸ“† Blocked Dates</h1>
      <p class="page-header__subtitle">Block specific dates when the hospital is closed (holidays, emergencies, maintenance)</p>
    </div>
    <button class="btn btn--primary" id="add-block-btn" type="button">+ Block Date</button>
  </div>

  <!-- Upcoming vs Past Tabs -->
  <div class="tabs" style="margin-bottom:var(--space-5);">
    <div class="tabs__nav" role="tablist">
      <button class="tabs__tab tabs__tab--active" data-tab="upcoming" role="tab" type="button">Upcoming / Active</button>
      <button class="tabs__tab" data-tab="past" role="tab" type="button">Past</button>
      <button class="tabs__tab" data-tab="all" role="tab" type="button">All</button>
    </div>
  </div>

  <!-- Loading -->
  <div id="loading" style="text-align:center;padding:var(--space-8);"><div class="spinner"></div></div>

  <!-- Empty State -->
  <div id="empty-state" class="empty-state" style="display:none;">
    <div class="empty-state__icon">ğŸ“†</div>
    <div class="empty-state__title">No Blocked Dates</div>
    <div class="empty-state__text">No dates are currently blocked. Click "+ Block Date" to add one.</div>
  </div>

  <!-- Blocked Dates List -->
  <div id="blocked-list" style="display:flex;flex-direction:column;gap:var(--space-3);display:none;"></div>
</main>

<!-- Add Block Modal -->
<div class="modal-backdrop" id="block-modal" style="display:none;" role="dialog" aria-modal="true" aria-labelledby="block-modal-title">
  <div class="modal modal--sm">
    <div class="modal__header">
      <div>
        <div class="modal__title" id="block-modal-title">Block a Date</div>
        <div class="modal__subtitle">Patients will not be able to book on this date</div>
      </div>
      <button class="modal__close" id="block-modal-close" aria-label="Close" type="button">âœ•</button>
    </div>
    <div class="modal__body">
      <form id="block-form" novalidate>
        <div class="form-group">
          <label class="form-label form-label--required" for="block-date">Date to Block</label>
          <input type="date" id="block-date" class="form-input" aria-required="true">
        </div>
        <div class="form-group">
          <label class="form-label" for="block-type">Type</label>
          <select id="block-type" class="form-input">
            <option value="holiday">Public Holiday</option>
            <option value="emergency">Emergency Closure</option>
            <option value="maintenance">Maintenance</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label form-label--required" for="block-reason">Reason / Notes</label>
          <input type="text" id="block-reason" class="form-input" placeholder="e.g. Eid al-Fitr, Hospital Maintenance" maxlength="200" aria-required="true">
        </div>
        <div class="form-group">
          <label class="form-label" for="block-affects">Affects</label>
          <select id="block-affects" class="form-input">
            <option value="all">All Departments (OPD + Clinics)</option>
            <option value="opd">OPD Only</option>
            <option value="clinic">Clinics Only</option>
          </select>
        </div>
      </form>
    </div>
    <div class="modal__footer">
      <button class="btn btn--ghost" id="block-modal-cancel" type="button">Cancel</button>
      <button class="btn btn--primary" id="block-modal-save" type="button">Block Date</button>
    </div>
  </div>
</div>

<!-- Remove Block Confirmation -->
<div class="modal-backdrop" id="remove-modal" style="display:none;" role="dialog" aria-modal="true">
  <div class="modal modal--sm modal--confirm" data-confirm-only="true">
    <div class="modal__header">
      <div><div class="modal__title" style="color:var(--color-danger-dark);">Remove Block</div></div>
    </div>
    <div class="modal__body">
      <p id="remove-modal-msg" style="color:var(--color-text-secondary);">Remove this date block? Patients will be able to book on this date again.</p>
    </div>
    <div class="modal__footer">
      <button class="btn btn--ghost" id="remove-modal-cancel" type="button">Keep</button>
      <button class="btn btn--danger" id="remove-modal-confirm" type="button">Remove Block</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js" crossorigin="anonymous"></script>
<script src="../../config.js"></script>
<script src="../../assets/js/utils.js"></script>
<script src="../../assets/js/supabase.js"></script>
<script src="../../assets/js/audit.js"></script>
<script src="../../assets/js/admin-auth.js"></script>

<script>
'use strict';

let adminSession = null;
let allBlocked = [];
let currentTab = 'upcoming';
let pendingRemoveId = null;

const TYPE_LABELS = { holiday: 'Public Holiday', emergency: 'Emergency', maintenance: 'Maintenance', other: 'Other' };
const AFFECTS_LABELS = { all: 'All Departments', opd: 'OPD Only', clinic: 'Clinics Only' };

async function initBlockedDates() {
  adminSession = await requireAdminAuth(['super_admin']);
  if (!adminSession) return;

  populateAdminNavbar(adminSession);
  initAdminNavbarMobile();

  document.querySelectorAll('[data-tab]').forEach(tab => {
    tab.addEventListener('click', () => {
      currentTab = tab.dataset.tab;
      document.querySelectorAll('[data-tab]').forEach(t => t.classList.toggle('tabs__tab--active', t === tab));
      renderBlocked();
    });
  });

  document.getElementById('add-block-btn').addEventListener('click', openBlockModal);
  document.getElementById('block-modal-close').addEventListener('click', () => closeModal('block-modal'));
  document.getElementById('block-modal-cancel').addEventListener('click', () => closeModal('block-modal'));
  document.getElementById('block-modal-save').addEventListener('click', saveBlock);
  document.getElementById('remove-modal-cancel').addEventListener('click', () => closeModal('remove-modal'));
  document.getElementById('remove-modal-confirm').addEventListener('click', confirmRemove);

  // Set min date on block input
  document.getElementById('block-date').min = new Date().toLocaleDateString('en-CA');

  await loadBlocked();
}

async function loadBlocked() {
  try {
    const db = getDB();
    const { data, error } = await db.from('blocked_dates').select('*').order('blocked_date', { ascending: false });
    if (error) throw new Error(error.message);
    allBlocked = data || [];
    renderBlocked();
  } catch (err) {
    Toast.error('Load Failed', err.message);
  } finally {
    document.getElementById('loading').style.display = 'none';
  }
}

function renderBlocked() {
  const today = new Date().toLocaleDateString('en-CA');
  let list = allBlocked;

  if (currentTab === 'upcoming') {
    list = allBlocked.filter(b => b.blocked_date >= today);
  } else if (currentTab === 'past') {
    list = allBlocked.filter(b => b.blocked_date < today);
  }

  if (list.length === 0) {
    document.getElementById('blocked-list').style.display = 'none';
    document.getElementById('empty-state').style.display = '';
    return;
  }

  document.getElementById('empty-state').style.display = 'none';
  const container = document.getElementById('blocked-list');
  container.innerHTML = list.map(b => {
    const dateLabel = new Date(b.blocked_date + 'T00:00:00').toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
    const isPast = b.blocked_date < today;
    return `
      <div class="card" style="border-left:3px solid ${isPast ? 'var(--color-text-muted)' : 'var(--color-danger)'};">
        <div class="card__body" style="display:flex;align-items:flex-start;gap:var(--space-4);">
          <div style="font-size:24px;">${isPast ? 'ğŸ“…' : 'ğŸš«'}</div>
          <div style="flex:1;">
            <div style="font-weight:700;font-size:var(--font-size-lg);">${DOMPurify.sanitize(dateLabel)}</div>
            <div style="display:flex;gap:var(--space-2);flex-wrap:wrap;margin-top:var(--space-2);">
              <span class="badge badge--${isPast ? 'inactive' : 'danger'}">${TYPE_LABELS[b.block_type] || b.block_type || 'Blocked'}</span>
              <span class="badge badge--info">${AFFECTS_LABELS[b.affects] || b.affects || 'All'}</span>
            </div>
            ${b.reason ? `<div style="margin-top:var(--space-2);font-size:var(--font-size-sm);color:var(--color-text-secondary);">${DOMPurify.sanitize(b.reason)}</div>` : ''}
          </div>
          ${!isPast ? `<button class="btn btn--danger btn--sm" onclick="openRemoveModal('${b.id}', '${DOMPurify.sanitize(dateLabel)}')" type="button">Remove</button>` : ''}
        </div>
      </div>
    `;
  }).join('');
  container.style.display = 'flex';
}

function openBlockModal() {
  document.getElementById('block-date').value = '';
  document.getElementById('block-type').value = 'holiday';
  document.getElementById('block-reason').value = '';
  document.getElementById('block-affects').value = 'all';
  clearAllFormErrors(document.getElementById('block-form'));
  openModal('block-modal');
}

function openRemoveModal(blockId, dateLabel) {
  pendingRemoveId = blockId;
  document.getElementById('remove-modal-msg').textContent = `Remove the block for "${dateLabel}"? Patients will be able to book on this date again.`;
  openModal('remove-modal');
}

async function saveBlock() {
  const date = document.getElementById('block-date').value;
  const type = document.getElementById('block-type').value;
  const reason = document.getElementById('block-reason').value.trim();
  const affects = document.getElementById('block-affects').value;
  const saveBtn = document.getElementById('block-modal-save');

  clearAllFormErrors(document.getElementById('block-form'));
  if (!date) { showFieldError(document.getElementById('block-date'), 'Date is required'); return; }
  if (!reason) { showFieldError(document.getElementById('block-reason'), 'Reason is required'); return; }

  disableSubmitButton(saveBtn, 'Saving...');
  try {
    const db = getDB();
    const { data, error } = await db.from('blocked_dates').insert({
      blocked_date: date,
      block_type: type,
      reason,
      affects,
      created_by: adminSession.id,
    }).select().single();

    if (error) throw new Error(error.message);
    await auditLog(adminSession.id, 'block_date', 'blocked_dates', data.id, { date, type, reason, affects });
    Toast.success('Blocked', `${date} has been blocked.`);
    closeModal('block-modal');
    await loadBlocked();
  } catch (err) {
    Toast.error('Save Failed', err.message);
  } finally {
    enableSubmitButton(saveBtn);
  }
}

async function confirmRemove() {
  if (!pendingRemoveId) return;
  const confirmBtn = document.getElementById('remove-modal-confirm');
  disableSubmitButton(confirmBtn, 'Removing...');
  try {
    const db = getDB();
    const { error } = await db.from('blocked_dates').delete().eq('id', pendingRemoveId);
    if (error) throw new Error(error.message);
    await auditLog(adminSession.id, 'unblock_date', 'blocked_dates', pendingRemoveId, {});
    Toast.success('Removed', 'Date block removed.');
    closeModal('remove-modal');
    await loadBlocked();
  } catch (err) {
    Toast.error('Error', err.message);
  } finally {
    enableSubmitButton(confirmBtn);
    pendingRemoveId = null;
  }
}

document.addEventListener('DOMContentLoaded', initBlockedDates);
</script>
</body>
</html>
